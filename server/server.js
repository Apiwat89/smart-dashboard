require('dotenv').config();
const express = require('express');
const cors = require('cors');
const { generateAIResponse } = require('./services/aiService');

const app = express();
app.use(cors());
app.use(express.json());

// =======================================================
// API 1: à¸ªà¸£à¸¸à¸›à¸ à¸²à¸žà¸£à¸§à¸¡ (Zone B) - à¹€à¸™à¹‰à¸™à¸ à¸²à¸©à¸²à¸—à¸²à¸‡à¸à¸²à¸£ à¸­à¹ˆà¸²à¸™à¸‡à¹ˆà¸²à¸¢ à¹„à¸¡à¹ˆà¸¡à¸µ Markdown
// =======================================================
app.post('/api/summarize-view', async (req, res) => {
    const { visibleCharts } = req.body;
    
    // Prompt à¸ªà¸±à¹ˆà¸‡à¹ƒà¸«à¹‰à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸—à¸µà¸¥à¸°à¸à¸£à¸²à¸Ÿ à¹à¸¥à¸°à¸«à¹‰à¸²à¸¡à¹ƒà¸Šà¹‰à¸­à¸±à¸à¸‚à¸£à¸°à¸žà¸´à¹€à¸¨à¸©
    const prompt = `
        à¸šà¸—à¸šà¸²à¸—: à¸„à¸¸à¸“à¸„à¸·à¸­ Senior Data Analyst à¸—à¸µà¹ˆà¹€à¸Šà¸µà¹ˆà¸¢à¸§à¸Šà¸²à¸à¸”à¹‰à¸²à¸™ Data Storytelling (à¸à¸²à¸£à¹€à¸¥à¹ˆà¸²à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸ˆà¸²à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥)

        à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸£à¸²à¸Ÿà¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ: 
        ${JSON.stringify(visibleCharts)}

        à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸à¸²à¸£à¸ˆà¸±à¸”à¸£à¸¹à¸›à¹à¸šà¸šà¸„à¸³à¸•à¸­à¸š (Layout & Style):
        1. à¹ƒà¸«à¹‰à¸•à¸­à¸šà¹€à¸›à¹‡à¸™à¸‚à¹‰à¸­à¹† à¸•à¸²à¸¡à¸ˆà¸³à¸™à¸§à¸™à¸à¸£à¸²à¸Ÿ (1., 2., 3.)
        2. **à¸ªà¸³à¸„à¸±à¸à¸¡à¸²à¸:** à¹ƒà¸«à¹‰à¹€à¸§à¹‰à¸™à¸šà¸£à¸£à¸—à¸±à¸”à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡à¸‚à¹‰à¸­à¸à¸±à¸šà¹€à¸™à¸·à¹‰à¸­à¸«à¸²à¸—à¸µà¹ˆà¸­à¸˜à¸´à¸šà¸²à¸¢à¸ˆà¸šà¹à¸¥à¹‰à¸§à¸à¹ˆà¸­à¸™à¸‚à¸¶à¹‰à¸™à¸‚à¹‰à¸­à¹ƒà¸«à¸¡à¹ˆà¹€à¸ªà¸¡à¸­ à¹€à¸žà¸·à¹ˆà¸­à¸„à¸§à¸²à¸¡à¸ªà¸§à¸¢à¸‡à¸²à¸¡ à¸­à¹ˆà¸²à¸™à¸‡à¹ˆà¸²à¸¢ (Whitespace is key)
        
        à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸£à¸¹à¸›à¹à¸šà¸šà¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£:
        "1. [à¸à¸£à¸²à¸Ÿ: à¸Šà¸·à¹ˆà¸­à¸à¸£à¸²à¸Ÿ]
        [à¸¢à¹ˆà¸­à¸«à¸™à¹‰à¸²à¹€à¸™à¸·à¹‰à¸­à¸«à¸²: à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹à¸™à¸§à¹‚à¸™à¹‰à¸¡à¸«à¸£à¸·à¸­à¸ˆà¸¸à¸”à¸ªà¸±à¸‡à¹€à¸à¸•à¸ªà¸³à¸„à¸±à¸ à¹‚à¸”à¸¢à¹ƒà¸Šà¹‰à¸ à¸²à¸©à¸²à¹„à¸—à¸¢à¸—à¸µà¹ˆà¸ªà¸¥à¸°à¸ªà¸¥à¸§à¸¢ à¹€à¸›à¹‡à¸™à¸—à¸²à¸‡à¸à¸²à¸£à¹à¸•à¹ˆà¸¥à¸·à¹ˆà¸™à¹„à¸«à¸¥ à¹€à¸«à¸¡à¸·à¸­à¸™à¹€à¸¥à¹ˆà¸²à¹ƒà¸«à¹‰à¸œà¸¹à¹‰à¸šà¸£à¸´à¸«à¸²à¸£à¸Ÿà¸±à¸‡ à¸à¸£à¸°à¸Šà¸±à¸šà¹à¸¥à¸°à¹„à¸”à¹‰à¹ƒà¸ˆà¸„à¸§à¸²à¸¡]"

        "2. [à¸à¸£à¸²à¸Ÿ: à¸Šà¸·à¹ˆà¸­à¸à¸£à¸²à¸Ÿ]
        [à¸¢à¹ˆà¸­à¸«à¸™à¹‰à¸²à¹€à¸™à¸·à¹‰à¸­à¸«à¸²...]"

        à¸‚à¹‰à¸­à¸«à¹‰à¸²à¸¡:
        - à¸«à¹‰à¸²à¸¡à¹€à¸à¸£à¸´à¹ˆà¸™à¸™à¸³à¹€à¸§à¸´à¹ˆà¸™à¹€à¸§à¹‰à¸­ à¹ƒà¸«à¹‰à¹€à¸£à¸´à¹ˆà¸¡à¸—à¸µà¹ˆà¸‚à¹‰à¸­ 1 à¹€à¸¥à¸¢
        - à¸«à¹‰à¸²à¸¡à¹ƒà¸Šà¹‰ Markdown (à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸¡à¸µà¸•à¸±à¸§à¸«à¸™à¸²/à¹€à¸­à¸µà¸¢à¸‡) à¹ƒà¸«à¹‰à¹ƒà¸Šà¹‰à¸à¸²à¸£à¹€à¸§à¹‰à¸™à¸šà¸£à¸£à¸—à¸±à¸”à¸Šà¹ˆà¸§à¸¢à¸ˆà¸±à¸”à¸£à¸°à¹€à¸šà¸µà¸¢à¸šà¹à¸—à¸™
    `;

    const reply = await generateAIResponse(prompt, "You are a professional Data Analyst. You speak Thai fluently.");
    res.json({ message: reply });
});

// =======================================================
// API 2: à¸•à¸±à¸§à¸à¸²à¸£à¹Œà¸•à¸¹à¸™ (Zone C) - à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹€à¸—à¸µà¸¢à¸šà¸à¸±à¸šà¹€à¸žà¸·à¹ˆà¸­à¸™à¸—à¸±à¹‰à¸‡à¸à¸£à¸²à¸Ÿ
// =======================================================
app.post('/api/character-reaction', async (req, res) => {
    try {
        const { pointData, contextData } = req.body; // à¸£à¸±à¸šà¸„à¹ˆà¸²à¸¡à¸²

        // Console Log à¸”à¸¹à¸«à¸™à¹ˆà¸­à¸¢à¸§à¹ˆà¸² Server à¹„à¸”à¹‰à¸£à¸±à¸šà¸‚à¸­à¸‡à¸„à¸£à¸šà¹„à¸«à¸¡
        // console.log("ðŸ“ Point:", pointData);
        // console.log("ðŸ“š Context:", contextData); 

        const prompt = `
            à¸šà¸—à¸šà¸²à¸—: à¸„à¸¸à¸“à¸„à¸·à¸­ "à¸™à¹‰à¸­à¸‡à¸ªà¹‰à¸¡à¸ˆà¸µà¹Šà¸”" (Somjeed) à¸¡à¸²à¸ªà¸„à¸­à¸• AI à¸œà¸¹à¹‰à¸Šà¹ˆà¸§à¸¢à¸ªà¸¸à¸”à¸£à¹ˆà¸²à¹€à¸£à¸´à¸‡ à¸‰à¸¥à¸²à¸” à¹à¸¥à¸°à¹€à¸›à¹‡à¸™à¸à¸±à¸™à¹€à¸­à¸‡
            
            à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸„à¸¥à¸´à¸: 
            - à¸Šà¸·à¹ˆà¸­à¸£à¸²à¸¢à¸à¸²à¸£: "${pointData.name}" 
            - à¸„à¹ˆà¸²à¸—à¸µà¹ˆà¹„à¸”à¹‰: ${pointData.uv}
            
            à¸šà¸£à¸´à¸šà¸—à¸‚à¸­à¸‡à¸à¸£à¸²à¸Ÿà¸™à¸µà¹‰: 
            ${JSON.stringify(contextData)}
            
            à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸à¸²à¸£à¸•à¸­à¸š:
            1. à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸„à¹ˆà¸²à¸—à¸µà¹ˆà¸„à¸¥à¸´à¸ (${pointData.uv}) à¹€à¸—à¸µà¸¢à¸šà¸à¸±à¸šà¸ à¸²à¸žà¸£à¸§à¸¡à¹€à¸žà¸·à¹ˆà¸­à¸™à¹† à¹ƒà¸™à¸à¸£à¸²à¸Ÿ
            - à¸¡à¸±à¸™à¹€à¸›à¹‡à¸™à¹à¸Šà¸¡à¸›à¹Œ (à¸ªà¸¹à¸‡à¸ªà¸¸à¸”)? à¸«à¸£à¸·à¸­à¸£à¸±à¹‰à¸‡à¸—à¹‰à¸²à¸¢ (à¸•à¹ˆà¸³à¸ªà¸¸à¸”)? à¸«à¸£à¸·à¸­à¹€à¸›à¹‡à¸™à¸„à¹ˆà¸²à¸¡à¸²à¸•à¸£à¸à¸²à¸™à¸—à¸±à¹ˆà¸§à¹„à¸›?
            2. à¹à¸ªà¸”à¸‡à¸­à¸²à¸£à¸¡à¸“à¹Œ (Reaction) à¹ƒà¸«à¹‰à¸ªà¸¡à¸šà¸—à¸šà¸²à¸—
            - à¸–à¹‰à¸²à¸„à¹ˆà¸²à¸ªà¸¹à¸‡/à¸”à¸µà¸¡à¸²à¸: à¸”à¸µà¹ƒà¸ˆ à¸•à¸·à¹ˆà¸™à¹€à¸•à¹‰à¸™ à¸Šà¸¡à¹€à¸Šà¸¢ ("à¸§à¹‰à¸²à¸§!", "à¸ªà¸¸à¸”à¸¢à¸­à¸”à¹„à¸›à¹€à¸¥à¸¢!")
            - à¸–à¹‰à¸²à¸„à¹ˆà¸²à¸•à¹ˆà¸³/à¹à¸¢à¹ˆ: à¹ƒà¸«à¹‰à¸à¸³à¸¥à¸±à¸‡à¹ƒà¸ˆ à¸«à¸£à¸·à¸­à¹à¸ªà¸”à¸‡à¸„à¸§à¸²à¸¡à¸•à¸à¹ƒà¸ˆà¹€à¸¥à¹‡à¸à¸™à¹‰à¸­à¸¢ ("à¸­à¸¸à¹Šà¸¢...", "à¸ªà¸¹à¹‰à¹† à¸™à¸°à¸„à¸°")
            - à¸–à¹‰à¸²à¸„à¹ˆà¸²à¸›à¸à¸•à¸´: à¸šà¸­à¸à¹€à¸¥à¹ˆà¸²à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸™à¹ˆà¸²à¸£à¸¹à¹‰
            3. à¹à¸—à¸™à¸•à¸±à¸§à¹€à¸­à¸‡à¸§à¹ˆà¸² "à¸ªà¹‰à¸¡à¸ˆà¸µà¹Šà¸”" à¹€à¸ªà¸¡à¸­ à¹à¸¥à¸°à¸¥à¸‡à¸—à¹‰à¸²à¸¢à¸”à¹‰à¸§à¸¢ "à¸„à¹ˆà¸°/à¸„à¸°"
            4. à¸«à¹‰à¸²à¸¡à¹ƒà¸Šà¹‰ Markdown (à¸«à¹‰à¸²à¸¡à¸•à¸±à¸§à¸«à¸™à¸²/à¸‚à¸µà¸”à¹€à¸ªà¹‰à¸™) à¸žà¸´à¸¡à¸žà¹Œà¹€à¸›à¹‡à¸™à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸˜à¸£à¸£à¸¡à¸”à¸²
            5. à¸„à¸§à¸²à¸¡à¸¢à¸²à¸§à¹„à¸¡à¹ˆà¹€à¸à¸´à¸™ 3-4 à¸›à¸£à¸°à¹‚à¸¢à¸„
        `;

        const reply = await generateAIResponse(prompt, "You are a helpful AI mascot.");
        res.json({ message: reply });

    } catch (error) {
        console.error("Server Error:", error);
        res.json({ message: "à¸£à¸°à¸šà¸šà¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥à¸¡à¸µà¸›à¸±à¸à¸«à¸²à¹€à¸¥à¹‡à¸à¸™à¹‰à¸­à¸¢à¸„à¸£à¸±à¸š" });
    }
});

app.listen(3000, () => console.log('Server running on port 3000'));